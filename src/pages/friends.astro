---

import MainGridLayout from "../layouts/MainGridLayout.astro";

import { getCollection, getEntry } from "astro:content";
import { render } from "astro:content";
import Markdown from "@components/misc/Markdown.astro";

const friendsPost = await getEntry("spec", "friends");

if (!friendsPost) {
	throw new Error("Friends page content not found");
}

const { Content } = await render(friendsPost);

const friends = await getCollection("friends");

import { execSync } from "node:child_process";

// 缓存 Git 日期，避免重复调用
const gitDateCache = new Map<string, Date>();

function getGitDate(id: string) {
	if (gitDateCache.has(id)) {
		return gitDateCache.get(id)!;
	}
	try {
		const filePath = `src/content/friends/${id}`;
		// 获取文件首次提交时间 (--diff-filter=A: 添加, --follow: 追踪重命名, %aI: ISO 8601 格式)
		const output = execSync(
			`git log --diff-filter=A --follow --format=%aI -1 -- "${filePath}"`,
			{ encoding: "utf-8" },
		);
		if (output && output.trim()) {
			const date = new Date(output.trim());
			gitDateCache.set(id, date);
			return date;
		}
	} catch (e) {
		// ignore error (e.g. file not committed yet)
	}
	// 如果获取失败（如未提交的新文件），使用文件系统创建时间或当前时间作为后备
	const now = new Date();
	gitDateCache.set(id, now);
	return now;
}

// 按提交时间排序：越早越靠前 (Ascending)
friends.sort((a, b) => {

	const dateA = getGitDate(a.id).getTime();
	const dateB = getGitDate(b.id).getTime();

	// 如果时间相同（例如都是本地未提交文件），则按文件名排序作为二级准则
	if (dateA === dateB) {
		return a.id.localeCompare(b.id);
	}

	return dateA - dateB;
});
---
<MainGridLayout title="友情链接 - 优质技术博客推荐" description="优质博客友情链接推荐，发现更多技术开发者的精彩内容。欢迎互换友链，共建优质技术社区生态。">
    <div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32 mb-4">
        <div class="card-base z-10 px-9 py-6 relative w-full ">
            <Markdown class="mt-2 text-xl font-bold">
                <Content />
            </Markdown>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-4 w-full mt-8">
                {friends.map(friend => (
                    <a href={friend.data.url} target="_blank" rel="noopener noreferrer"
                       class="card-base flex items-center p-4 hover:bg-[var(--card-bg-hover)] transition-colors group">
                        <div class="w-16 h-16 rounded-full overflow-hidden shrink-0 mr-4 border border-black/5 dark:border-white/5 bg-white/50 dark:bg-black/20">
                            <img src={friend.data.avatar} alt={friend.data.name} class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300" loading="lazy" />
                        </div>
                        <div class="flex flex-col justify-center overflow-hidden">
                            <div class="font-bold text-lg text-[var(--primary)] mb-1 truncate">{friend.data.name}</div>
                            <div class="text-sm text-black/50 dark:text-white/50 line-clamp-2">{friend.data.introduction}</div>
                        </div>
                    </a>
                ))}
            </div>
        </div>
    </div>
</MainGridLayout>
